import{_ as n,o as e,c as l,ag as t,j as s,a}from"./chunks/framework.DEqXEGcv.js";const b=JSON.parse('{"title":"Ros2 bag","description":"","frontmatter":{},"headers":[],"relativePath":"2 计算机/开发框架/ROS2/04-ros2bag.md","filePath":"2 计算机/开发框架/ROS2/04-ros2bag.md","lastUpdated":1770949611000}'),p={name:"2 计算机/开发框架/ROS2/04-ros2bag.md"};function r(h,i,d,o,k,c){return e(),l("div",null,[...i[0]||(i[0]=[t(`<h1 id="ros2-bag" tabindex="-1">Ros2 bag <a class="header-anchor" href="#ros2-bag" aria-label="Permalink to &quot;Ros2 bag&quot;">​</a></h1> <p><a href="https://deepwiki.com/ros2/rosbag2" target="_blank" rel="noreferrer">ros2/rosbag2 | DeepWiki</a></p> <h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2> <p>rosbag2是用于记录和回放ROS 2通信的官方工具。它能够从主题、服务和动作中捕获带时间戳的消息，并将其存储为数据包文件，从而支持数据回放功能，用于测试验证、调试排障、数据分析和仿真复现。</p> <table tabindex="0"><thead><tr><th>命令</th> <th>功能描述</th></tr></thead> <tbody><tr><td>ros2 bag convert</td> <td>根据输入的数据包，使用不同设置写出新的数据包</td></tr> <tr><td>ros2 bag info</td> <td>在屏幕上打印数据包的信息</td></tr> <tr><td>ros2 bag list</td> <td>在屏幕上打印可用插件的信息</td></tr> <tr><td>ros2 bag play</td> <td>从数据包回放ROS数据</td></tr> <tr><td>ros2 bag record</td> <td>将ROS数据记录到数据包</td></tr> <tr><td>ros2 bag reindex</td> <td>为数据包重建元数据文件</td></tr> <tr><td><strong>录制功能</strong></td> <td></td></tr></tbody></table> <ul><li><strong>主题发现</strong>：动态监测并自动识别新出现的主题</li> <li><strong>过滤机制</strong>：支持通过正则表达式、排除模式或显式列表指定记录目标</li> <li><strong>QoS适配</strong>：自动匹配发布者的服务质量配置</li> <li><strong>数据包分割</strong>：根据文件大小或持续时间自动拆分存储文件</li> <li><strong>压缩功能</strong>：支持可插拔格式的消息级/文件级压缩</li> <li><strong>快照模式</strong>：按需触发的环形缓冲区录制</li> <li><strong>服务/动作记录</strong>：完整捕获服务调用与动作通信数据</li></ul> <p><strong>回放功能</strong></p> <ul><li><strong>速率控制</strong>：通过<code>--rate</code>参数或运行时服务调整回放速度</li> <li><strong>时间控制</strong>：在<code>/clock</code>主题发布仿真时间戳</li> <li><strong>跳转定位</strong>：支持基于时间戳的精准片段回放</li> <li><strong>过滤回放</strong>：可选定特定主题/服务/动作进行回放</li> <li><strong>循环模式</strong>：提供连续循环回放便于测试验证</li> <li><strong>服务/动作回放</strong>：完整重放服务请求与动作目标数据</li></ul> <h2 id="ros-2-bag" tabindex="-1">ros 2 bag <a class="header-anchor" href="#ros-2-bag" aria-label="Permalink to &quot;ros 2 bag&quot;">​</a></h2> <p>ROS 1 最关键和基本的部分之一是其持久数据记录机制，称为 rosbags。为了在记录时保持高性能，<strong>rosbags 避免了记录消息的序列化和反序列化。</strong></p> <p>袋文件的回放必须是确定的。这意味着当顺序播放袋文件 n 次时，接收端应接收到确定的序列 n 次。这可以<strong>通过在记录时正确标记每条 incoming message 的时间戳来实现</strong>。时间戳可以是两重的：<strong>第一次是实际消息离开发布者时的时间戳，第二次是消息被接收并存储在袋文件中的时间戳。</strong></p> <p><strong>当考虑将 rosbag 文件作为长期存储时，可能会出现从录制到回放的时间段内消息定义已发生变化的情况。</strong> 为了应对这种情况，回放功能应提供一种机制将旧消息转换为新的定义。这可能仅限于新消息定义的字段添加。这意味着所有重叠的字段都应进行转移，而新添加的字段可以默认。显然，执行此转换步骤需要反序列化 ROS 2 消息，不能在高效回放序列化数据时完成。</p> <h3 id="ros-2-bag-技术要求" tabindex="-1">ros 2 bag 技术要求 <a class="header-anchor" href="#ros-2-bag-技术要求" aria-label="Permalink to &quot;ros 2 bag 技术要求&quot;">​</a></h3> <ol><li>确定性：多次回放保证数据序列确定</li> <li>适应性：消息字段添加</li> <li>可扩展性</li> <li>随机访问：无需遍历对某个主题的第 n 条消息的随机访问</li> <li>范围访问</li> <li>可变数据块大小</li> <li>与 ROS 1 的向后兼容性</li></ol> <h3 id="ros-2-bags-的设计方案" tabindex="-1">ros 2 bags 的设计方案 <a class="header-anchor" href="#ros-2-bags-的设计方案" aria-label="Permalink to &quot;ros 2 bags 的设计方案&quot;">​</a></h3> <p>ros 2 bag 自下而上被分为 3 层：</p> <ol><li>数据包存储 api 层：与 ROS 2 解耦，仅负责读写抽象的二进制消息</li> <li>数据包 api 层：负责获取 ROS 2 消息，对其进行序列化并添加充分描述信息，以供存储 API 层写入</li> <li>数据包命令行接口层：为用户提供了控制数据包录制与回放的入口</li></ol> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110102836.png" alt="image.png" loading="lazy"></p> <h4 id="存储-api-层" tabindex="-1">存储 api 层 <a class="header-anchor" href="#存储-api-层" aria-label="Permalink to &quot;存储 api 层&quot;">​</a></h4> <p>负责以<strong>二进制格式</strong>存储传入的 ROS 消息的底层软件包。数据存储负责持久保存 ROS 消息及其足够的元信息，以便在加载时恢复其完整上下文。</p> <h5 id="数据编码" tabindex="-1">数据编码 <a class="header-anchor" href="#数据编码" aria-label="Permalink to &quot;数据编码&quot;">​</a></h5> <p>ros 2 消息 &lt;&lt;=[唯一性]=&gt;&gt; 二进制</p> <h5 id="数据存储" tabindex="-1">数据存储 <a class="header-anchor" href="#数据存储" aria-label="Permalink to &quot;数据存储&quot;">​</a></h5> <p>抽象表示：实际消息的二进制数据块以及一个键值对元数据
支持多种数据存储解决方案（例如 SQLite 或 <a href="http://wiki.ros.org/Bags/Format/2.0" target="_blank" rel="noreferrer">rosbag format2</a> ）</p> <p>该 API 能够：</p> <ol><li>支持多种数据存储；</li> <li>将数据从一个存储传输到另一个存储。</li></ol> <h5 id="sqlite" tabindex="-1">Sqlite <a class="header-anchor" href="#sqlite" aria-label="Permalink to &quot;Sqlite&quot;">​</a></h5> <p>ros 2 选择 sqlite 作为默认的解决方案。</p> <p>理由：</p> <ul><li>轻量级依赖，在各主流平台经过充分测试</li> <li>单文件即可运行，便于初期 API 开发和存储实现</li> <li>基准测试显示写入速度可达&gt;1 GB/s（大消息场景下接近磁盘写入极限）</li> <li>高频小消息处理性能优异（&gt;10 万条/秒）</li></ul> <p>优势：</p> <ul><li>表结构无需预定义，可灵活扩展</li> <li>支持标准 SQL 语法和工具进行查询</li></ul> <p>劣势：</p> <ul><li>与直接将传入数据转储到文件的格式（例如 ROS 1 rosbag）相比，写入性能可能存在缺陷。</li></ul> <h5 id="可插拔数据存储" tabindex="-1">可插拔数据存储 <a class="header-anchor" href="#可插拔数据存储" aria-label="Permalink to &quot;可插拔数据存储&quot;">​</a></h5> <p>ros 2 为该 API 层实现可扩展的插件架构，该架构能够连接各种数据存储解决方案，从而使用户有机会根据自己的用例优化数据存储。</p> <h5 id="api-设计" tabindex="-1">api 设计 <a class="header-anchor" href="#api-设计" aria-label="Permalink to &quot;api 设计&quot;">​</a></h5> <p>存储 API 接口设计如下（完整 API 可能采用 C 语言接口+C++实现，便于 Python/Java 等语言绑定）：</p> <ol><li>open：进程初始化时调用，准备数据读写格式</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> file_path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> impl_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="2"><li>close：进程退出时调用</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="3"><li>create_topic：对于每个要记录的新主题， <strong><code>create topic</code> 函数</strong>都会被调用一次。它接收连接信息、指示相应二进制数据编码的唯一标识符、数据块大小，并且可以接受一个可选的指针来存储特定于实现的数据。<strong>这里隐含的约定是每个主题只能有一种编码方式。不支持同一消息和同一主题使用混合编码。</strong></li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TopicHandle</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ConnectionHeader</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> connection_header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> encoding_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> chunk_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> impl_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110105833.png" alt="image.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110110224.png" alt="image.png" loading="lazy"></p> <ol start="4"><li>open_topic：读取主题时获取句柄</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TopicHandle</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> open_topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> topic_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="5"><li>write：持久化存储数据，通过主题句柄定位存储位置</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TopicHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> time_received</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SerializedData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> serialized_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> impl_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="6"><li>read_next：迭代器式顺序读取（可选主题过滤）</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SerializedData</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read_next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IteratorHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> iter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TopicHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> impl_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="7"><li>read：索引式范围查询（支持多主题和时间范围检索，可指定排序方式）</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SerializedData[] </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (struct query, enum order_by, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> impl_data)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="8"><li>info：获取存储数据的统计信息（主题列表、总时长等）</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagInfo</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="9"><li>index：录制完成后创建索引文件（YAML 格式），存储元数据</li></ol> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BagHandle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h5 id="数据结构定义" tabindex="-1">数据结构定义 <a class="header-anchor" href="#数据结构定义" aria-label="Permalink to &quot;数据结构定义&quot;">​</a></h5> <p>连接头信息（扩展 ROS 1 头信息，增加 QoS 参数）：</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConnectionHeader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string topic_name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string topic_type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string message_definition,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string message_md </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">_sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quality_of_service_params</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>序列化数据载体：</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SerializedData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  byte[] payload,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>数据包信息（扩展 ROS 1 info，增加键值对存储）：</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BagInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string path,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file_size,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  time duration,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  time start,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  time end,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> message_count,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> topic_count,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string[] topics,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string[] types,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  map[string, string] key_value_data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>主题句柄（封装编码信息）：</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TopicHandle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string topic_name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string topic_type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  string encoding_identifier</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="rosbag-api" tabindex="-1">rosbag API <a class="header-anchor" href="#rosbag-api" aria-label="Permalink to &quot;rosbag API&quot;">​</a></h4> <p>rosbag API 描述了记录、回放以及读取和写入 ROS 消息所需的接口。它负责将传入的消息以正确的数据格式存储到数据存储中。同样，该 API 还必须能够根据数据存储中的二进制表示，恢复 ROS 消息的原始数据格式。</p> <p>rosbag API 提供通用函数，支持在任意 ROS 2 消息与可用编码格式之间进行双向序列化/反序列化。默认提供 CDR 格式的插件实现，使所有中间件都能通过该函数将 CDR 数据反序列化为 ROS 2 消息，并可按需序列化为自身编码格式。这种可插拔序列化机制是实现通用 rosbag 的唯一途径，同时会带来显著性能开销。</p> <p>如果给 <code>ros2 bag record</code> 命令指定了编码选项（例如 <code>--encoding</code> ），则每个传入的 ROS 2 消息在存储到 bag 之前都会被序列化为指定的编码格式。相反，如果没有指定任何选项，<code>rosbag</code> API 会直接以二进制格式接收传入的消息，并可以直接将其转发到存储 API，而无需进行任何进一步的序列化。</p> <h5 id="api-1" tabindex="-1">API 1 <a class="header-anchor" href="#api-1" aria-label="Permalink to &quot;API 1&quot;">​</a></h5> <p>与存储层交互，提供 ROS 2 消息的读写功能及其与指定编码格式的转换。</p> <h5 id="api-2" tabindex="-1">API 2 <a class="header-anchor" href="#api-2" aria-label="Permalink to &quot;API 2&quot;">​</a></h5> <p>实现 ROS 2 消息的发布/订阅传输机制。这些函数会订阅一组主题，记录传入的消息并将其写入存储 API。回放操作则相反，给定一个查询，将查询结果对应的主题发布出去。</p> <h4 id="rosbag-cli" tabindex="-1">rosbag CLI <a class="header-anchor" href="#rosbag-cli" aria-label="Permalink to &quot;rosbag CLI&quot;">​</a></h4> <p>rosbag CLI 将作为现有 <a href="https://github.com/ros2/ros2cli" target="_blank" rel="noreferrer">ros2cli</a> 的一个新动词集成，并为 bag 文件的简单录制和回放提供入口点。这个命令行包仅作为一个简单的接口，不包含任何重要的 API。大部分逻辑都在 rosbag API 中实现。</p> <h4 id="可选功能" tabindex="-1">可选功能 <a class="header-anchor" href="#可选功能" aria-label="Permalink to &quot;可选功能&quot;">​</a></h4> <ul><li>并行 IO</li> <li>压缩</li></ul> <h3 id="包结构" tabindex="-1">包结构 <a class="header-anchor" href="#包结构" aria-label="Permalink to &quot;包结构&quot;">​</a></h3> <div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/Workspace/bag_files ⌚ 14:56:53</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ros2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> info</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  rosbag2_2025_11_10-14_55_45/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Files:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             rosbag2_2025_11_10-14_55_45_0.db3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Bag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          25.0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> KiB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Storage</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> id:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        sqlite3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Duration:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          28.998816488s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Start:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             Nov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2025</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 14:55:46.627438064</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (1762757746.627438064)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">End:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">               Nov</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2025</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 14:56:15.626254552</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (1762757775.626254552)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Messages:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> information:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> base_interfaces_demo/msg/Test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Serialization</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Format:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cdr</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/Workspace/bag_files ⌚ 14:57:01</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tree</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rosbag2_2025_11_10-14_55_45</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rosbag2_2025_11_10-14_55_45</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> metadata.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">└──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rosbag2_2025_11_10-14_55_45_0.db3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> directories,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> files</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/Workspace/bag_files ⌚ 14:57:24</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rosbag2_2025_11_10-14_55_45/metadata.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rosbag2_bagfile_information:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  storage_identifier:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sqlite3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  duration:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    nanoseconds:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 28998816488</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  starting_time:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    nanoseconds_since_epoch:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1762757746627438064</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  message_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  topics_with_message_count:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topic_metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /topic</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> base_interfaces_demo/msg/Test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        serialization_format:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cdr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        offered_qos_profiles:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;- history: 3\\n  depth: 0\\n  reliability: 1\\n  durability: 2\\n  deadline:\\n    sec: 9223372036\\n    nsec: 854775807\\n  lifespan:\\n    sec: 9223372036\\n    nsec: 854775807\\n  liveliness: 1\\n  liveliness_lease_duration:\\n    sec: 9223372036\\n    nsec: 854775807\\n  avoid_ros_namespace_conventions: false&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      message_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  compression_format:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  compression_mode:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  relative_file_paths:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rosbag2_2025_11_10-14_55_45_0.db3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  files:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> path:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rosbag2_2025_11_10-14_55_45_0.db3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      starting_time:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        nanoseconds_since_epoch:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1762757746627438064</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      duration:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        nanoseconds:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 28998816488</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      message_count:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 30%</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="ros-2-bags-五层架构" tabindex="-1">ros 2 bags 五层架构 <a class="header-anchor" href="#ros-2-bags-五层架构" aria-label="Permalink to &quot;ros 2 bags 五层架构&quot;">​</a></h3> <p><a href="https://deepwiki.com/ros2/rosbag2/3.1-transport-layer" target="_blank" rel="noreferrer">Transport Layer | ros2/rosbag2 | DeepWiki</a></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110144804.png" alt="image.png" loading="lazy"></p> <p>各层职责：</p> <ol><li>user layer：命令行接口与 launch 文件集成</li> <li>python bindings：提供 pybind 11 生成的 python 接口</li> <li>transport layer：包含作为 rclcpp:: Node 组件的 player 与 recorder（<code>Player</code> 和 <code>Recorder</code> 均以 <code>rclcpp</code> 组件的形式实现，可以加载到组件容器中以进行进程内通信）</li> <li>core c++ layer：实现了存储 I/O、压缩和转换逻辑</li> <li>storage plugin layer：具有可插拔存储和压缩实现的抽象接口</li></ol> <p>rosbag2的核心组件：
<a href="https://deepwiki.com/ros2/rosbag2/1.2-packages-and-components" target="_blank" rel="noreferrer">Packages and Components | ros2/rosbag2 | DeepWiki</a></p> <p>关键类：</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110152026.png" alt="image.png" loading="lazy"></p> <h3 id="传输层" tabindex="-1">传输层 <a class="header-anchor" href="#传输层" aria-label="Permalink to &quot;传输层&quot;">​</a></h3> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110151540.png" alt="image.png" loading="lazy"></p> <p>传输层使用 ROS 2 的通用发布和订阅机制来处理任意类型的消息。</p> <h4 id="基于服务的控制接口-rolling" tabindex="-1">基于服务的控制接口（rolling） <a class="header-anchor" href="#基于服务的控制接口-rolling" aria-label="Permalink to &quot;基于服务的控制接口（rolling）&quot;">​</a></h4> <p>两个节点都暴露了 ROS 2 服务以进行运行时控制：</p> <p><strong>Player Services</strong> (namespace: <code>~/</code>):</p> <ul><li><code>pause</code>, <code>resume</code>, <code>toggle_paused</code>, <code>is_paused</code></li> <li><code>get_rate</code>, <code>set_rate</code></li> <li><code>seek</code>, <code>play_next</code>, <code>burst</code></li> <li><code>play</code>, <code>stop</code></li></ul> <p><strong>Recorder Services</strong> (namespace: <code>~/</code>):</p> <ul><li><code>pause</code>, <code>resume</code>, <code>is_paused</code></li> <li><code>split_bagfile</code></li> <li><code>snapshot</code> (仅在启用快照模式时)</li></ul> <h4 id="时间控制系统" tabindex="-1">时间控制系统 <a class="header-anchor" href="#时间控制系统" aria-label="Permalink to &quot;时间控制系统&quot;">​</a></h4> <p><a href="https://github.com/ros2/rosbag2/blob/humble/docs/design/rosbag2_playback_time.md" target="_blank" rel="noreferrer">rosbag2/docs/design/rosbag2_playback_time.md at humble · ros2/rosbag2 --- rosbag2/docs/design/rosbag2_playback_time.md at humble · ros2/rosbag2</a></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110153056.png" alt="image.png" loading="lazy"></p> <p>rosbag 2 中的时间控制系统负责管理播放时间，从而可以精确控制录制消息的重放方式。该系统负责协调播放的时间特性，包括播放速率控制、暂停/恢复和时间跳转功能。</p> <p>在回放 ros 2 bags 时，时间控制系统决定：</p> <ul><li>根据时间戳确定何时发布下一条消息</li> <li>如何控制播放速度（比实时速度快/慢）</li> <li>如何实现暂停和恢复功能</li> <li>如何处理时间跳跃（跳过过去或回到过去）</li></ul> <p>该系统将时间管理与消息的实际发布解耦，从而在 rosbag 2 架构中实现了清晰的关注点分离。</p> <p>时间控制系统维护一个参考点，该参考点建立了两个时间域之间的关系：</p> <ol><li><strong>ROS 时间</strong> ：ROS 消息中使用的时间戳域</li> <li><strong>稳定时间</strong> ：用于测量实际经过时间的现实世界时钟</li></ol> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251113112224.png" alt="image.png" loading="lazy"></p> <p>该参考允许系统在这些域之间进行转换，从而使其能够根据 ROS 时间戳确定何时发布消息。</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251110154622.png" alt="image.png" loading="lazy"></p> <h3 id="存储层" tabindex="-1">存储层 <a class="header-anchor" href="#存储层" aria-label="Permalink to &quot;存储层&quot;">​</a></h3> <h4 id="表结构" tabindex="-1">表结构 <a class="header-anchor" href="#表结构" aria-label="Permalink to &quot;表结构&quot;">​</a></h4> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251113103028.png" alt="" loading="lazy"></p> <h2 id="service-action-记录与回放-rolling-版本" tabindex="-1">Service/Action 记录与回放 (rolling 版本) <a class="header-anchor" href="#service-action-记录与回放-rolling-版本" aria-label="Permalink to &quot;Service/Action 记录与回放 (rolling 版本)&quot;">​</a></h2> <h3 id="rosbag-2-服务记录与回放功能" tabindex="-1">Rosbag 2 服务记录与回放功能 <a class="header-anchor" href="#rosbag-2-服务记录与回放功能" aria-label="Permalink to &quot;Rosbag 2 服务记录与回放功能&quot;">​</a></h3> <p><a href="https://github.com/ros2/rosbag2/blob/rolling/docs/design/rosbag2_record_replay_service.md" target="_blank" rel="noreferrer">rosbag2/docs/design/rosbag2_record_replay_service.md at rolling · ros2/rosbag2</a></p> <h4 id="背景说明" tabindex="-1">背景说明 <a class="header-anchor" href="#背景说明" aria-label="Permalink to &quot;背景说明&quot;">​</a></h4> <p>在 <a href="https://github.com/ros2/rosbag2/issues/773" target="_blank" rel="noreferrer">ros2/rosbag2#773</a> 议题中，社区建议为 rosbag 2 增加记录服务请求的功能。</p> <p>本文档将描述如何基于当前架构实现该功能，并扩展现有命令行参数。</p> <h4 id="服务消息记录原理" tabindex="-1">服务消息记录原理 <a class="header-anchor" href="#服务消息记录原理" aria-label="Permalink to &quot;服务消息记录原理&quot;">​</a></h4> <p>服务内省机制 (<a href="https://github.com/ros2/ros2/issues/1285" target="_blank" rel="noreferrer">ros2/ros2#1285</a>) 已实现。所有服务消息（请求与响应）都会发布到名为 <code>_service_event</code> 的隐藏主题下（例如 /add_two_ints/_service_event）。因此可以通过记录普通主题的方式捕获这些消息。</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">service-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">configure_introspection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  node-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  rclcpp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ServicesQoS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  RCL_SERVICE_INTROSPECTION_CONTENTS);</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="服务事件主题识别方法" tabindex="-1">服务事件主题识别方法 <a class="header-anchor" href="#服务事件主题识别方法" aria-label="Permalink to &quot;服务事件主题识别方法&quot;">​</a></h4> <p>服务事件主题虽以普通主题形式存储，但在读取录制文件后需要区别处理。识别标准如下：</p> <div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- 普通主题  </span></span>
<span class="line"><span>  [命名空间/]主题名</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 隐藏主题  </span></span>
<span class="line"><span>  [命名空间/]_主题名</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 服务事件主题  </span></span>
<span class="line"><span>  [命名空间/]服务名/_service_event</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>具体判定标准：</p> <ol><li>主题以 <code>/_service_event</code> 结尾</li> <li>主题类型名称匹配 <code>*/srv/*_Event</code> 模式（例如 <code>example_interfaces/srv/AddTwoInts_Event</code>）</li></ol> <h4 id="新增-修改命令" tabindex="-1">新增/修改命令 <a class="header-anchor" href="#新增-修改命令" aria-label="Permalink to &quot;新增/修改命令&quot;">​</a></h4> <p>新增命令：ros2 service echo</p> <p>ros 2 bag record​ 更新列表：</p> <table tabindex="0"><thead><tr><th>参数</th> <th>类型</th> <th>功能描述</th></tr></thead> <tbody><tr><td><code>--services</code></td> <td>新增</td> <td>指定要记录的服务列表（至少一个服务名）</td></tr> <tr><td><code>--all-topics</code></td> <td>新增</td> <td>记录所有普通主题（自动排除隐藏主题，含服务事件主题）</td></tr> <tr><td><code>--all-services</code></td> <td>新增</td> <td>记录所有服务事件主题</td></tr> <tr><td><code>--exclude-regex</code></td> <td>修改</td> <td>通过正则表达式排除主题和服务</td></tr> <tr><td><code>--exclude-topics</code></td> <td>新增</td> <td>设置不记录的主题黑名单</td></tr> <tr><td><code>--exclude-services</code></td> <td>新增</td> <td>设置不记录的服务黑名单</td></tr> <tr><td>ros 2 bag play​ 更新列表：</td> <td></td> <td></td></tr></tbody></table> <table tabindex="0"><thead><tr><th>参数</th> <th>类型</th> <th>功能描述</th></tr></thead> <tbody><tr><td><code>--publish-service-requests</code></td> <td>新增</td> <td>根据记录的服务内省消息重放服务请求</td></tr> <tr><td><code>--service-requests-source</code></td> <td>新增</td> <td>指定服务请求来源：  <br>• service_introspection - 服务内省消息  <br>• client_introspection - 客户端内省消息</td></tr> <tr><td><code>--services</code></td> <td>新增</td> <td>指定要重放的服务列表</td></tr> <tr><td><code>--exclude-topics</code></td> <td>新增</td> <td>设置不重放的主题黑名单</td></tr> <tr><td><code>--exclude-services</code></td> <td>新增</td> <td>设置不重放的服务黑名单</td></tr> <tr><td><code>--exclude-regex</code></td> <td>修改</td> <td>通过正则表达式排除主题和服务</td></tr></tbody></table> <h3 id="rosbag-2-动作记录与回放功能" tabindex="-1">Rosbag 2 动作记录与回放功能 <a class="header-anchor" href="#rosbag-2-动作记录与回放功能" aria-label="Permalink to &quot;Rosbag 2 动作记录与回放功能&quot;">​</a></h3> <p><a href="https://github.com/ros2/rosbag2/blob/rolling/docs/design/rosbag2_record_replay_action.md" target="_blank" rel="noreferrer">rosbag2/docs/design/rosbag2_record_replay_action.md at rolling · ros2/rosbag2</a></p> <h4 id="背景说明-1" tabindex="-1">背景说明 <a class="header-anchor" href="#背景说明-1" aria-label="Permalink to &quot;背景说明&quot;">​</a></h4> <p>本文档基于当前架构描述动作记录与回放功能的实现方案，并说明如何扩展现有命令行参数。</p> <h4 id="动作消息记录原理" tabindex="-1">动作消息记录原理 <a class="header-anchor" href="#动作消息记录原理" aria-label="Permalink to &quot;动作消息记录原理&quot;">​</a></h4> <p>动作的实现使用三个服务和两个主题。启用服务内省功能后，rosbag 2 可通过服务事件主题记录动作相关数据（参考 <a href="./rosbag2_record_replay_service.html">rosbag2_record_replay_service.md</a>），因此可完整记录动作的所有通信数据。</p> <h4 id="动作记录涉及的主题-服务" tabindex="-1">动作记录涉及的主题/服务 <a class="header-anchor" href="#动作记录涉及的主题-服务" aria-label="Permalink to &quot;动作记录涉及的主题/服务&quot;">​</a></h4> <div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>- 目标提交服务  </span></span>
<span class="line"><span>  [命名空间/]动作名/_action/send_goal  </span></span>
<span class="line"><span>  服务事件主题：[命名空间/]动作名/_action/send_goal/_service_event</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 结果获取服务  </span></span>
<span class="line"><span>  [命名空间/]动作名/_action/get_result  </span></span>
<span class="line"><span>  服务事件主题：[命名空间/]动作名/_action/get_result/_service_event</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 目标取消服务  </span></span>
<span class="line"><span>  [命名空间/]动作名/_action/cancel_goal  </span></span>
<span class="line"><span>  服务事件主题：[命名空间/]动作名/_action/cancel_goal/_service_event</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 状态主题  </span></span>
<span class="line"><span>  [命名空间/]动作名/_action/status</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 反馈主题  </span></span>
<span class="line"><span>  [命名空间/]动作名/_action/feedback</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>每个动作将记录五个相关主题/服务事件主题。、</p> <h4 id="扩展-record-命令参数" tabindex="-1">扩展 &#39;record&#39; 命令参数 <a class="header-anchor" href="#扩展-record-命令参数" aria-label="Permalink to &quot;扩展 &#39;record&#39; 命令参数&quot;">​</a></h4> <p>新增参数：</p> <table tabindex="0"><thead><tr><th style="text-align:left;">参数名称</th> <th style="text-align:left;">功能描述</th></tr></thead> <tbody><tr><td style="text-align:left;">--actions 动作名 [动作名 ...]</td> <td style="text-align:left;">要记录的动作列表（空格分隔）</td></tr> <tr><td style="text-align:left;">--all-actions</td> <td style="text-align:left;">通过服务事件主题和隐藏主题记录所有动作</td></tr> <tr><td style="text-align:left;">--exclude-actions 动作名 [动作名 ...]</td> <td style="text-align:left;">不记录的动作列表（空格分隔），可与其他过滤参数叠加使用</td></tr></tbody></table> <p>更新参数：</p> <table tabindex="0"><thead><tr><th style="text-align:left;">参数名称</th> <th style="text-align:left;">功能描述</th></tr></thead> <tbody><tr><td style="text-align:left;">-a, --all</td> <td style="text-align:left;">记录所有主题、服务和<strong>动作</strong>（排除其他隐藏主题）</td></tr> <tr><td style="text-align:left;">-e 正则表达式, --regex 正则表达式</td> <td style="text-align:left;">仅记录匹配正则表达式的主题、服务和<strong>动作</strong>（注意：--all, --all-topics, --all-services 或 <strong>--all-actions</strong> 会覆盖此参数）</td></tr> <tr><td style="text-align:left;">--exclude-regex 排除正则表达式</td> <td style="text-align:left;">排除匹配正则表达式的主题、服务和动作（可与其他参数叠加使用）</td></tr></tbody></table> <h4 id="扩展-play-命令参数" tabindex="-1">扩展 &#39;play&#39; 命令参数 <a class="header-anchor" href="#扩展-play-命令参数" aria-label="Permalink to &quot;扩展 &#39;play&#39; 命令参数&quot;">​</a></h4> <p>新增参数：</p> <table tabindex="0"><thead><tr><th style="text-align:left;">参数名称</th> <th style="text-align:left;">功能描述</th></tr></thead> <tbody><tr><td style="text-align:left;">--actions 动作名 [动作名 ...]</td> <td style="text-align:left;">要回放的动作列表（空格分隔）</td></tr> <tr><td style="text-align:left;">--exclude-actions 动作名 [动作名 ...]</td> <td style="text-align:left;">不回放的动作列表（空格分隔）</td></tr> <tr><td style="text-align:left;">--send-actions-as-client</td> <td style="text-align:left;">基于记录的服务事件消息分别发送 send_goal、cancel_goal 和 get_result 请求。注意：动作的&quot;状态主题&quot;和&quot;反馈主题&quot;消息不会被发送，因为这些应由动作服务器端发送。</td></tr></tbody></table> <p>更新参数：</p> `,283),s("table",{tabindex:"0"},[s("thead",null,[s("tr",null,[s("th",{style:{"text-align":"left"}},"参数名称"),a(),s("th",{style:{"text-align":"left"}},"功能描述")])]),a(),s("tbody",null,[s("tr",null,[s("td",{style:{"text-align":"left"}},"-e 正则表达式, --regex 正则表达式"),a(),s("td",{style:{"text-align":"left"}},[a("仅回放匹配正则表达式的主题、服务和"),s("strong",null,"动作")])]),a(),s("tr",null,[s("td",{style:{"text-align":"left"}},"-x 排除正则表达式, --exclude-regex 排除正则表达式"),a(),s("td",{style:{"text-align":"left"}},[a("通过正则表达式排除不回放的主题、服务和"),s("strong",null,"动作")])]),a(),s("tr",null,[s("td",{style:{"text-align":"left"},"service_introspection,":"",client_introspection:""},"--service-requests-source"),a(),s("td",{style:{"text-align":"left"}},'指定服务请求的回放来源。需与"--publish-service-requests"或**"--send-actions-as-client"**参数配合使用，默认为记录的服务内省消息。')])])],-1)])])}const u=n(p,[["render",r]]);export{b as __pageData,u as default};
