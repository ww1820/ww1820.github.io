import{_ as i,o as a,c as n,ag as e}from"./chunks/framework.DEqXEGcv.js";const c=JSON.parse('{"title":"调研","description":"","frontmatter":{"tags":["cpp","zmq","Linux"]},"headers":[],"relativePath":"2 计算机/中间件/ZeroMQ/zmq设置hwm.md","filePath":"2 计算机/中间件/ZeroMQ/zmq设置hwm.md","lastUpdated":1770949611000}'),t={name:"2 计算机/中间件/ZeroMQ/zmq设置hwm.md"};function p(l,s,h,k,r,E){return a(),n("div",null,[...s[0]||(s[0]=[e(`<p>主要代码：</p> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CReqRepMachine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CReqRepMachine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PortGroup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hwm) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">m_port_group</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    zmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">context_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DCContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Instance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ZmqContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // std::cout &lt;&lt; &quot;hwm: &quot; &lt;&lt; hwm &lt;&lt; std::endl; </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 请求链路</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_front.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> zmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">socket_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">socket_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::router));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_front-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setsockopt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ZMQ_RCVHWM, hwm);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_front-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setsockopt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ZMQ_SNDHWM, hwm);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_back.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> zmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">socket_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zmq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">socket_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::dealer));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_back-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setsockopt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ZMQ_RCVHWM, hwm);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m_socket_back-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setsockopt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ZMQ_SNDHWM, hwm);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 回报链路</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // m_socket_front_1.reset(new zmq::socket_t(context, zmq::socket_type::push));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // m_socket_back_1.reset(new zmq::socket_t(context, zmq::socket_type::pull));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PersistQrySpi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (m_action_api </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nullptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m_action_api </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IActionServerApi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CreateApi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m_action_api-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetHighWaterMark</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m_action_api-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;persist_qry&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>数据库内数据条数：</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20231214102839.png" alt="image.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20231214103441.png" alt="image.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_1702521189647.png" alt="企业微信截图_1702521189647.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20231214103631.png" alt="image.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20231214103701.png" alt="image.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_17025217233894.png" alt="企业微信截图_17025217233894.png" loading="lazy"></p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_17025218108177.png" alt="企业微信截图_17025218108177.png" loading="lazy"></p> <h1 id="调研" tabindex="-1">调研 <a class="header-anchor" href="#调研" aria-label="Permalink to &quot;调研&quot;">​</a></h1> <p><a href="https://zguide.zeromq.org/docs/chapter2/#High-Water-Marks" target="_blank" rel="noreferrer">2. Sockets and Patterns | ØMQ - The Guide (zeromq.org)</a></p> <p>ZeroMQ uses the concept of HWM (high-water mark) to define the capacity of its internal pipes. Each connection out of a socket or into a socket has its own pipe, and HWM for sending, and/or receiving, depending on the socket type. Some sockets (PUB, PUSH) only have send buffers. Some (SUB, PULL, REQ, REP) only have receive buffers. Some (DEALER, ROUTER, PAIR) have both send and receive buffers.</p> <p>ZeroMQ 使用 HWM（高水位线）的概念来定义其内部管道的容量。每个从套接字发出或进入套接字的连接都有自己的管道，以及用于发送和/或接收的 HWM，具体取决于套接字类型。某些套接字（PUB、PUSH）仅具有发送缓冲区。有些（SUB、PULL、REQ、REP）仅具有接收缓冲区。有些（DEALER、ROUTER、PAIR）同时具有发送和接收缓冲区。</p> <p>In ZeroMQ v2.x, the HWM was infinite by default. This was easy but also typically fatal for high-volume publishers. In ZeroMQ v3.x, it’s set to 1,000 by default, which is more sensible. If you’re still using ZeroMQ v2.x, you should always set a HWM on your sockets, be it 1,000 to match ZeroMQ v3.x or another figure that takes into account your message sizes and expected subscriber performance.</p> <p>在 ZeroMQ v2.x 中，HWM 默认是无限的。这很容易，但对于大批量出版商来说通常也是致命的。在 ZeroMQ v3.x 中，默认设置为1,000，这是更合理的。如果您仍在使用 ZeroMQ v2.x，则应始终在套接字上设置 HWM，可以是 1,000 以匹配 ZeroMQ v3.x，也可以是考虑到消息大小和预期订阅者性能的其他数字。</p> <p>When your socket reaches its HWM, it will either block or drop data depending on the socket type. PUB and ROUTER sockets will drop data if they reach their HWM, while other socket types will block. Over the inproc transport, the sender and receiver share the same buffers, so the real HWM is the sum of the HWM set by both sides.</p> <p>当您的套接字达到其 HWM 时，它将根据套接字类型阻止或删除数据。 PUB 和 ROUTER 套接字如果达到其 HWM 将丢弃数据，而其他套接字类型将阻塞。在 inproc 传输中，发送方和接收方共享相同的缓冲区，因此真正的 HWM 是双方设置的 HWM 之和。</p> <p>Lastly, the HWMs are not exact; while you may get <em>up to</em> 1,000 messages by default, the real buffer size may be much lower (as little as half), due to the way libzmq implements its queues.</p> <p>最后，HWM 并不精确；虽然默认情况下您最多可以获得 1,000 条消息，但由于 libzmq 实现其队列的方式，实际缓冲区大小可能要低得多（只有一半）。</p> <p>原文
How does the HWM (high water mark) work with any socket type?</p> <p>On PUB and ROUTER sockets, when the SNDHWM is reached on outgoing pipes, messages are dropped. DEALER and PUSH sockets will block when their outgoing pipes are full. On incoming pipes, SUB sockets will drop received messages when they reach their RCVHWM. PULL and DEALER sockets will refuse new messages and force messages to wait upstream due to TCP backpressure.</p> <p>翻译
HWM（高水位标记）与各种套接字类型一起使用时会发生什么事？</p> <p>在 PUB 和 ROUTER 类型套接字上，当在传出管道上达到 SNDHWM 时，将会丢弃消息。而 DEALER 和 PUSH 类型套接字将会堵塞。在传入管道上，到达 RCVHWM 时，SUB 类型套接字将会丢弃消息，而 PULL 和 DEALER 套接字将拒绝新消息并强制消息在上游等待。</p>`,46)])])}const g=i(t,[["render",p]]);export{c as __pageData,g as default};
