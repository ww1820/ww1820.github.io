import{_ as a,o as i,c as n,ag as e}from"./chunks/framework.DEqXEGcv.js";const g=JSON.parse('{"title":"04-命令行工具框架","description":"","frontmatter":{},"headers":[],"relativePath":"2 计算机/开发框架/ROS2/04-命令行工具框架.md","filePath":"2 计算机/开发框架/ROS2/04-命令行工具框架.md","lastUpdated":1770949611000}'),l={name:"2 计算机/开发框架/ROS2/04-命令行工具框架.md"};function t(o,s,r,p,c,h){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="_04-命令行工具框架" tabindex="-1">04-命令行工具框架 <a class="header-anchor" href="#_04-命令行工具框架" aria-label="Permalink to &quot;04-命令行工具框架&quot;">​</a></h1> <p><a href="https://deepwiki.com/ros2/ros2cli/1-ros-2-cli-overview" target="_blank" rel="noreferrer">ros2/ros2cli | DeepWiki</a></p> <h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2> <p>ROS 2 命令行界面 (CLI) 提供了一套用于与 ROS 2 系统交互和管理的命令行工具。它是用户检查、操作和与各种 ROS 2 实体（例如节点、主题、服务、动作和参数）交互的主要界面。</p> <h3 id="主要特点" tabindex="-1">主要特点 <a class="header-anchor" href="#主要特点" aria-label="Permalink to &quot;主要特点&quot;">​</a></h3> <ul><li>基于框架的可扩展架构</li> <li>一致的命令结构 <code>ros2 &lt;command&gt; &lt;verb&gt; &lt;arguments&gt;</code></li> <li>守护进程以提高性能</li> <li>使用 tab 自动补全命令、动词和参数</li> <li>支持与所有主要的 ros2 概念进行交互</li></ul> <h3 id="架构概览" tabindex="-1">架构概览 <a class="header-anchor" href="#架构概览" aria-label="Permalink to &quot;架构概览&quot;">​</a></h3> <p>ROS 2 CLI 采用模块化、基于插件的架构设计，便于扩展。</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107132751.png" alt="image.png" loading="lazy"></p> <p>ros2cli 框架主要分为两部分：</p> <ul><li>插件系统：发现和加载命令扩展及其动词</li> <li>节点策略：通过直接节点或守护进程提供 ROS2 图通信</li></ul> <h3 id="插件系统" tabindex="-1">插件系统 <a class="header-anchor" href="#插件系统" aria-label="Permalink to &quot;插件系统&quot;">​</a></h3> <p>ROS 2 CLI 利用 Python 的 entry points 机制实现了一个灵活的插件系统。这使得模块化扩展无需修改核心代码库即可实现。</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107152436.png" alt="image.png" loading="lazy"></p> <h4 id="插件系统架构和工作流程" tabindex="-1">插件系统架构和工作流程 <a class="header-anchor" href="#插件系统架构和工作流程" aria-label="Permalink to &quot;插件系统架构和工作流程&quot;">​</a></h4> <h5 id="_1-入口点注册阶段-entry-point-registration" tabindex="-1">1. 入口点注册阶段 (Entry Point Registration)** <a class="header-anchor" href="#_1-入口点注册阶段-entry-point-registration" aria-label="Permalink to &quot;1. 入口点注册阶段 (Entry Point Registration)**&quot;">​</a></h5> <p><strong>setuptools entry_points</strong>​ 作为注册中心，包含三种类型的扩展点：</p> <ul><li><code>ros2cli.command</code>: 注册主命令（如 <code>topic</code>, <code>node</code>, <code>service</code>）</li> <li><code>ros2cli.extension_point</code>: 定义新的扩展点</li> <li><code>command.verb</code>: 注册命令的具体功能（如 <code>list</code>, <code>echo</code>, <code>pub</code>）</li></ul> <p>命令和动词是通过每个软件包的 setup. py 文件中的入口点注册的：</p> <div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 定义入口点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entry_points</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 主命令注册 (ros2cli.command)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 向 \`ros2\`命令行工具注册一个名为 \`topic\`的子命令，当用户输入 \`ros2 topic\`时，会调用 \`TopicCommand\`类</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;ros2cli.command&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;topic = ros2topic.command.topic:TopicCommand&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 定义一个新的扩展点命名空间 ros2topic.verb</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;ros2cli.extension_point&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;ros2topic.verb = ros2topic.verb:VerbExtension&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 具体功能实现 (ros2topic.verb)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;ros2topic.verb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;bw = ros2topic.verb.bw:BwVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;delay = ros2topic.verb.delay:DelayVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;echo = ros2topic.verb.echo:EchoVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;find = ros2topic.verb.find:FindVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;hz = ros2topic.verb.hz:HzVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;info = ros2topic.verb.info:InfoVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;list = ros2topic.verb.list:ListVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;pub = ros2topic.verb.pub:PubVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &#39;type = ros2topic.verb.type:TypeVerb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="_2-扩展加载阶段-extension-loading" tabindex="-1">2. <strong>扩展加载阶段 (Extension Loading)</strong> <a class="header-anchor" href="#_2-扩展加载阶段-extension-loading" aria-label="Permalink to &quot;2. **扩展加载阶段 (Extension Loading)**&quot;">​</a></h5> <p><strong>CLI Extension Loader</strong>​ 在运行时：</p> <ul><li>扫描所有已安装包的 entry_points</li> <li>动态发现和加载可用扩展</li> <li>实例化扩展对象</li></ul> <h5 id="_3-命令执行阶段-cli-execution" tabindex="-1">3. <strong>命令执行阶段 (CLI Execution)</strong> <a class="header-anchor" href="#_3-命令执行阶段-cli-execution" aria-label="Permalink to &quot;3. **命令执行阶段 (CLI Execution)**&quot;">​</a></h5> <div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户输入 → Command Parser → Command Executor → 结果输出 </span></span>
<span class="line"><span>   ↓               ↓                 ↓ </span></span>
<span class="line"><span>解析命令    匹配可用命令/动词    执行具体业务逻辑</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="扩展接口" tabindex="-1">扩展接口 <a class="header-anchor" href="#扩展接口" aria-label="Permalink to &quot;扩展接口&quot;">​</a></h4> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107135755.png" alt="image.png" loading="lazy"></p> <p>系统定义了两个主要扩展接口：</p> <p><strong>CommandExtension</strong>​ - 实现顶级命令的接口：</p> <ul><li>NAME属性（设置为入口点名称）</li> <li>用于执行命令的 <code>main(*, parser, args)</code> 方法
<strong>VerbExtension</strong>​ - 为特定命令实现子命令的接口：</li> <li>NAME属性（设置为入口点名称）</li> <li>用于执行子命令的<code>main(*, args)</code>方法</li></ul> <h3 id="节点策略" tabindex="-1">节点策略 <a class="header-anchor" href="#节点策略" aria-label="Permalink to &quot;节点策略&quot;">​</a></h3> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107151316.png" alt="image.png" loading="lazy"></p> <p>ROS 2 CLI 需要与 ros2 graph 交互才能执行大多数命令。 <strong>CLI Command</strong>​ 通过 <strong>NodeStrategy</strong>​ 接口来执行与 ROS 2 Graph 的连接操作，连接方式分为两种：</p> <ul><li><strong>直接连接（DirectNode）</strong>：CLI 命令直接创建一个独立的 ROS 2 节点并接入系统；</li> <li><strong>守护进程连接（DaemonNode）</strong>：CLI 命令不直接创建节点，而是通过一个 <strong>XML-RPC Server</strong>​ 与一个长期运行、具备网络感知能力的节点（<strong>NetworkAwareNode</strong>）进行通信。</li></ul> <table tabindex="0"><thead><tr><th>策略类型</th> <th>描述</th> <th>特点</th></tr></thead> <tbody><tr><td><strong>直接节点策略</strong>​</td> <td>每次命令执行时创建一个新的ROS 2节点</td> <td>• 实现较简单但开销较大  <br>• 由于需要创建/销毁节点，重复命令执行较慢  <br>• 在守护进程不可用时仍可工作</td></tr> <tr><td><strong>守护进程节点策略</strong>​</td> <td>与持久的守护进程进行通信</td> <td>• 为重复命令提供更好的性能  <br>• 保持与 ROS 2 图的持久连接  <br>• 使用 XML-RPC 接口在 CLI 和守护进程间通信  <br>• 需要时会自动启动守护进程</td></tr></tbody></table> <h3 id="命令执行流程" tabindex="-1">命令执行流程 <a class="header-anchor" href="#命令执行流程" aria-label="Permalink to &quot;命令执行流程&quot;">​</a></h3> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107134121.png" alt="image.png" loading="lazy"></p> <p>以 <code>ros2 topic echo /chatter</code> 为例, 不启动守护进程时命令执行的流程：</p> <ol><li><p><strong>用户输入命令</strong>：用户在终端输入 <code>ros2 topic echo /chatter</code>。</p></li> <li><p><strong>命令加载与解析</strong>：</p> <ul><li><code>ros2</code> 主程序将 <code>topic</code> 部分交给 <strong>Command Factory</strong>。</li> <li>工厂找到并加载对应的 <code>TopicCommand</code>（<strong>Command Implementation</strong>​）实例。</li> <li><code>TopicCommand</code> 解析剩余参数，识别出动词 <code>echo</code>，并加载对应的 <code>EchoVerb</code>（<strong>Verb Implementation</strong>​）实例。</li></ul></li> <li><p><strong>执行与 ROS 2 交互</strong>：</p> <ul><li><code>EchoVerb</code> 开始执行。它通过 <strong>Node Strategy</strong>（节点策略）创建一个 ROS 2 节点。</li> <li>使用这个节点向 <strong>ROS 2 Graph</strong> 订阅 <code>/chatter</code> 话题。</li></ul></li> <li><p><strong>消息循环显示</strong>：</p> <ul><li>一旦有消息发布到 <code>/chatter</code> 话题，<strong>ROS 2 Graph</strong>​ 会通过回调函数将消息传递给 <code>EchoVerb</code>。</li> <li><code>EchoVerb</code> 将消息内容打印到终端（Display message）。</li> <li>循环直到用户主动中断命令。</li></ul></li></ol> <h2 id="部分命令行工具实现" tabindex="-1">部分命令行工具实现 <a class="header-anchor" href="#部分命令行工具实现" aria-label="Permalink to &quot;部分命令行工具实现&quot;">​</a></h2> <h3 id="topic-监控命令-hz-bw-delay" tabindex="-1">topic 监控命令 (hz/bw/delay) <a class="header-anchor" href="#topic-监控命令-hz-bw-delay" aria-label="Permalink to &quot;topic 监控命令 (hz/bw/delay)&quot;">​</a></h3> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251107153312.png" alt="image.png" loading="lazy"></p> <h4 id="_1-命令行接口" tabindex="-1">1. 命令行接口 <a class="header-anchor" href="#_1-命令行接口" aria-label="Permalink to &quot;1. 命令行接口&quot;">​</a></h4> <ol><li><strong>命令输入</strong>：用户在终端输入命令，例如 <code>ros2 topic hz /chatter</code></li> <li><strong>参数解析</strong>：CLI 系统解析命令参数</li> <li><strong>创建直接节点</strong>：系统创建一个 <strong>DirectNode</strong>（直接节点）</li></ol> <h4 id="_2-监控逻辑" tabindex="-1">2. 监控逻辑 <a class="header-anchor" href="#_2-监控逻辑" aria-label="Permalink to &quot;2. 监控逻辑&quot;">​</a></h4> <ol><li><strong>订阅主题</strong>：该逻辑使用上一步创建的 <code>DirectNode</code>来订阅用户指定的主题（如 <code>/chatter</code>）</li> <li><strong>统计收集器类</strong>：根据解析出的动词（<code>hz</code>/<code>bw</code>/<code>delay</code>），<strong>实例化一个对应的统计类</strong></li> <li><strong>统计类</strong>：
<ul><li><code>ROSTopicHz</code>：计算并输出消息发布频率</li> <li><code>ROSTopicBandwidth</code>：计算并输出主题所占用的网络带宽</li> <li><code>ROSTopicDelay</code>：计算消息间的延迟或端到端延迟（如果有相关信息）</li></ul></li> <li><strong>时间窗口缓冲</strong>：统计收集器类会维护一个<strong>时间窗口缓冲区</strong>，它会缓存一段时间内收到的消息（包括时间戳、消息大小等元数据）</li></ol> <h4 id="_3-结果计算与显示" tabindex="-1">3. 结果计算与显示 <a class="header-anchor" href="#_3-结果计算与显示" aria-label="Permalink to &quot;3. 结果计算与显示&quot;">​</a></h4> <ol><li><strong>计算统计量</strong>：统计收集器类基于<strong>时间窗口缓冲区</strong>内的数据，执行特定的算法（如计算平均时间间隔、总数据量等），得到最终的统计结果</li> <li><strong>显示结果</strong>：计算出的统计结果输出到终端上</li></ol>`,93)])])}const b=a(l,[["render",t]]);export{g as __pageData,b as default};
