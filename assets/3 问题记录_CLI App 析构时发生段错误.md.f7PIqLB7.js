import{_ as a,o as i,c as n,ag as e}from"./chunks/framework.DEqXEGcv.js";const k=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"3 问题记录/CLI App 析构时发生段错误.md","filePath":"3 问题记录/CLI App 析构时发生段错误.md","lastUpdated":1770889489000}'),l={name:"3 问题记录/CLI App 析构时发生段错误.md"};function p(t,s,r,h,d,o){return i(),n("div",null,[...s[0]||(s[0]=[e(`<h2 id="问题现象" tabindex="-1">问题现象 <a class="header-anchor" href="#问题现象" aria-label="Permalink to &quot;问题现象&quot;">​</a></h2> <p>程序在退出时发生 <strong>段错误（Segmentation Fault）</strong>，通过 <code>gdb</code> 查看调用栈发现，崩溃发生在 <code>CLI::App</code> 对象的析构过程中。</p> <p><img src="https://blog-1312962011.cos.ap-nanjing.myqcloud.com/imgs/20251229154408048.png" alt="image.png" loading="lazy"></p> <h2 id="根本原因" tabindex="-1">根本原因 <a class="header-anchor" href="#根本原因" aria-label="Permalink to &quot;根本原因&quot;">​</a></h2> <ul><li><code>CLI::App</code> 在析构时会调用其子命令（subcommand）对象的析构函数。</li> <li>这些子命令对象中包含 <strong>模板函数或回调函数</strong>，其实例化代码位于 <strong>动态加载的 <code>.so</code> 插件库</strong> 中。</li> <li>当 <code>CLI::App</code> 析构时，如果插件库已经被卸载（如 <code>dlclose()</code> 被调用），则这些函数地址失效。</li> <li>导致析构过程中跳转到无效内存 → 触发 <strong>段错误</strong>。</li></ul> <h2 id="关键机制" tabindex="-1">关键机制 <a class="header-anchor" href="#关键机制" aria-label="Permalink to &quot;关键机制&quot;">​</a></h2> <ul><li>C++ 中 <strong>栈上对象按声明逆序析构</strong>。</li> <li>若 <code>PluginManager</code>（负责加载/管理插件）的生命周期 <strong>短于</strong> <code>CLI::App</code>，即 <code>PluginManager</code> 先析构并卸载插件，则 <code>CLI::App</code> 析构时依赖的插件代码已不可用。</li></ul> <h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h2> <p>确保 <strong>插件管理器（PluginManager）的生命周期长于 CLI::App</strong>。具体做法：</p> <h3 id="✅-正确对象声明顺序-栈对象" tabindex="-1">✅ 正确对象声明顺序（栈对象） <a class="header-anchor" href="#✅-正确对象声明顺序-栈对象" aria-label="Permalink to &quot;✅ 正确对象声明顺序（栈对象）&quot;">​</a></h3> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    PluginManager pm;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 先声明 → 后析构（插件保持加载）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::App app;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // 后声明 → 先析构（此时插件仍可用）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... setup subcommands from plugins ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* args */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // app 先析构 → pm 后析构 → 安全</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="✅-或使用显式作用域控制" tabindex="-1">✅ 或使用显式作用域控制 <a class="header-anchor" href="#✅-或使用显式作用域控制" aria-label="Permalink to &quot;✅ 或使用显式作用域控制&quot;">​</a></h3> <div class="language-cpp vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::App app;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PluginManager pm;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 注册来自插件的子命令到 app</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // ❌ 错误：pm 先析构，app 析构时插件已卸载！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre> <div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>⚠️ <strong>重要原则</strong>：任何依赖动态库中代码的对象（如 CLI 子命令、回调、shared_ptr 等），必须在其所依赖的插件句柄/管理器<strong>之前完成析构</strong>。</p></blockquote> <h2 id="补充建议" tabindex="-1">补充建议 <a class="header-anchor" href="#补充建议" aria-label="Permalink to &quot;补充建议&quot;">​</a></h2> <ul><li>避免在插件中定义需跨模块析构的非平凡类型（尤其是含虚函数或模板实例化的类）。</li> <li>考虑将 CLI 命令注册限制在插件内部完成，并通过接口隔离生命周期。</li></ul>`,29)])])}const g=a(l,[["render",p]]);export{k as __pageData,g as default};
